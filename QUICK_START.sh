#!/bin/bash
# üöÄ –ë–´–°–¢–†–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –î–ï–ü–õ–û–Ø –ë–û–¢–ê –ù–ê –£–î–ê–õ–Å–ù–ù–´–ô –°–ï–†–í–ï–†

# ======================================================
# –≠–¢–ê–ü 1: –ü–û–î–ì–û–¢–û–í–ö–ê –ù–ê –õ–û–ö–ê–õ–¨–ù–û–ô –ú–ê–®–ò–ù–ï
# ======================================================

# –°–∫–æ–ø–∏—Ä—É–π –≤—Å–µ —Ñ–∞–π–ª—ã Docker –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞:
# - Dockerfile
# - docker-compose.yml
# - .dockerignore
# - requirements.txt
# - .env.example

# –î–æ–±–∞–≤—å –≤ .gitignore:
echo ".env" >> .gitignore
echo "data/" >> .gitignore
echo ".git" >> .gitignore

# –ó–∞–∫–æ–º–º–∏—Ç–∏–º –≤ git (–±–µ–∑ .env –∏ data)
git add .
git commit -m "Add Docker configuration for deployment"
git push


# ======================================================
# –≠–¢–ê–ü 2: –ü–û–î–ì–û–¢–û–í–ö–ê –°–ï–†–í–ï–†–ê
# ======================================================

# 1. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH
# ssh user@server.com

# 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
sudo apt-get update && sudo apt-get upgrade -y
curl -fsSL https://get.docker.com | sudo sh
sudo usermod -aG docker $USER
newgrp docker

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
docker --version
docker-compose --version


# ======================================================
# –≠–¢–ê–ü 3: –†–ê–ó–í–Å–†–¢–´–í–ê–ù–ò–ï –ë–û–¢–ê
# ======================================================

# 1. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd /opt
mkdir -p antibars-bot
cd antibars-bot

# 2. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏–ª–∏ –∫–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
# –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ git
git clone https://github.com/—Ç–≤–æ–π-—é–∑–µ—Ä/HammonDDDDD.git .
cd lab4

# –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ scp (—Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã)
# scp -r ./lab4/* user@server.com:/opt/antibars-bot/

# 3. –°–æ–∑–¥–∞—ë–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p data logs

# 4. –ö–æ–ø–∏—Ä—É–µ–º Google Sheets credentials
# –° –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã:
# scp antibars-credentials.json user@server.com:/opt/antibars-bot/data/

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º:
ls -la data/antibars-credentials.json

# 5. –°–æ–∑–¥–∞—ë–º .env —Ñ–∞–π–ª
cp .env.example .env

# 6. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º .env (–≤—Å—Ç–∞–≤–ª—è–µ–º —Å–≤–æ–π BOT_TOKEN)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º nano –∏–ª–∏ vi
nano .env

# –°–æ–¥–µ—Ä–∂–∏–º–æ–µ .env –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# BOT_TOKEN=—Ç–≤–æ–π_—Ç–æ–∫–µ–Ω_–∑–¥–µ—Å—å
# PYTHONUNBUFFERED=1

# 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –≤—ã—Ö–æ–¥–∏–º (Ctrl+O, Enter, Ctrl+X –¥–ª—è nano)


# ======================================================
# –≠–¢–ê–ü 4: –ó–ê–ü–£–°–ö –ö–û–ù–¢–ï–ô–ù–ï–†–ê
# ======================================================

# 1. –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
docker-compose build

# 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
docker-compose up -d

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
docker-compose ps

# 4. –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏
docker-compose logs -f antibars-bot

# –ï—Å–ª–∏ –≤–∏–¥–∏—à—å "Async echo bot started" –∏ "–ë–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞" - –≤—Å—ë –û–ö!
# –ù–∞–∂–º–∏ Ctrl+C —á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –∏–∑ –ª–æ–≥–æ–≤


# ======================================================
# –≠–¢–ê–ü 5: –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–û–°–¢–ò
# ======================================================

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥–æ–π –±–æ—Ç–∞ –≤ Telegram:
# /weather –ú–æ—Å–∫–≤–∞
# /quote
# /headlines
# /set_isu 123456

# –ï—Å–ª–∏ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ


# ======================================================
# –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´ –ü–û–°–õ–ï –î–ï–ü–õ–û–Ø
# ======================================================

# –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker-compose logs -f antibars-bot

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
docker-compose restart

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
docker-compose down

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞
docker-compose up -d

# –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
git pull
docker-compose build --no-cache
docker-compose restart


# ======================================================
# –ê–í–¢–û–ó–ê–ü–£–°–ö –ü–†–ò –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ï –°–ï–†–í–ï–†–ê
# ======================================================

# Docker Compose —É–∂–µ –∏–º–µ–µ—Ç restart: unless-stopped
# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è!

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
docker-compose ps


# ======================================================
# BACKUP –ë–î
# ======================================================

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–æ–∑–¥–∞—ë–º backup
docker-compose exec antibars-bot cp data/bars_db.sqlite data/bars_db.sqlite.backup

# –ö–æ–ø–∏—Ä—É–µ–º backup –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É
scp user@server.com:/opt/antibars-bot/data/bars_db.sqlite.backup ./


# ======================================================
# üéØ –í–°–Å! –ë–û–¢ –ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï
# ======================================================

# –ü–∏—à–∏ –≤ Telegram, —Ç–µ—Å—Ç–∏—Ä—É–π —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–∞—Å–ª–∞–∂–¥–∞–π—Å—è! üöÄ
